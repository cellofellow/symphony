# Generated by Django 2.1 on 2018-11-05 04:12

from django.db import migrations


DROPS = [
    """DROP TRIGGER library_piece_composer_artists_search_delete""",
    """DROP TRIGGER library_piece_arranger_artists_search_delete""",
]
CREATES = [
    """
    CREATE TRIGGER library_piece_composer_artists_search_delete
    AFTER DELETE ON library_piece_composer_artists
    FOR EACH ROW
    BEGIN
        UPDATE piece_search
        SET body = (
              SELECT
                  title || ' ' ||
                  subtitle || ' ' ||
                  comment || ' ' ||
                  COALESCE(GROUP_CONCAT(composer.given_names || ' ' || composer.surname), '') || ' ' ||
                  COALESCE(GROUP_CONCAT(arranger.given_names || ' ' || arranger.surname), '')
              FROM library_piece AS piece
              LEFT JOIN library_piece_composer_artists AS pc
                           ON piece.id = pc.piece_id
              LEFT JOIN library_piece_arranger_artists AS pa
                           ON piece.id = pa.piece_id
                    LEFT JOIN library_artist AS composer
                           ON pc.artist_id = composer.id
                    LEFT JOIN library_artist AS arranger
                           ON pa.artist_id = arranger.id
              WHERE piece.id = NEW.piece_id
            )
        WHERE id = NEW.piece_id;
    END
    """,
    """
    CREATE TRIGGER library_piece_arranger_artists_search_delete
    AFTER DELETE ON library_piece_arranger_artists
    FOR EACH ROW
    BEGIN
        UPDATE piece_search
        SET body = (
              SELECT
                  title || ' ' ||
                  subtitle || ' ' ||
                  comment || ' ' ||
                  COALESCE(GROUP_CONCAT(composer.given_names || ' ' || composer.surname), '') || ' ' ||
                  COALESCE(GROUP_CONCAT(arranger.given_names || ' ' || arranger.surname), '')
              FROM library_piece AS piece
              LEFT JOIN library_piece_composer_artists AS pc
                           ON piece.id = pc.piece_id
              LEFT JOIN library_piece_arranger_artists AS pa
                           ON piece.id = pa.piece_id
                    LEFT JOIN library_artist AS composer
                           ON pc.artist_id = composer.id
                    LEFT JOIN library_artist AS arranger
                           ON pa.artist_id = arranger.id
              WHERE piece.id = NEW.piece_id
            )
        WHERE id = NEW.piece_id;
    END
    """,
]

FORWARDS = DROPS + [q.replace('NEW.', 'OLD.') for q in CREATES]
REVERSE = DROPS + CREATES

class Migration(migrations.Migration):

    dependencies = [
        ('library', '0011_recreate_fts4'),
    ]

    operations = [
        migrations.RunSQL(FORWARDS, REVERSE),
    ]
